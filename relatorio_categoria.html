<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relat√≥rio de Estoque por Categoria</title>

  <link rel="stylesheet" href="style.css?v=12" />
  <link rel="icon" href="logo.jpeg" type="image/jpeg" />

  <script>
    // Bloqueia acesso direto se n√£o estiver logado
    if (!sessionStorage.getItem("logado")) {
      window.location.href = "login.html";
    }
  </script>
</head>
<body style="display:block;">
  <div class="main" style="margin:0; padding: 16px;">
    <div class="topbar" style="margin-bottom: 8px;">
      <a href="index.html" class="toggle-sidebar" style="text-decoration:none; display:inline-block;">‚Üê Voltar</a>
      <h1 class="titulo-app" style="margin-left:12px;">Relat√≥rio de Estoque por Categoria</h1>
    </div>

    <div class="container">
      <h2 id="tituloCategoria">Categoria</h2>

      <!-- Bot√µes de exporta√ß√£o -->
      <div class="actions export-buttons" style="margin: 8px 0 14px 0;">
        <button class="btn-excel" id="btnExcel">üì• Excel</button>
        <button class="btn-pdf" id="btnPDF">üßæ PDF</button>
      </div>

      <div class="table-responsive">
        <table id="tabelaCategoria">
          <tr><th>Material</th><th>Quantidade</th></tr>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Util: pegar ?tipo=...
    function getTipoFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('tipo') || '';
    }

    // Carrega dados da categoria via PHP
    function carregarTabelaCategoria(tipo) {
      const tabela = document.getElementById('tabelaCategoria');
      // limpa linhas antigas (exceto header)
      tabela.querySelectorAll('tr:not(:first-child)').forEach(tr => tr.remove());

      fetch('listar_estoque_por_tipo.php?tipo=' + encodeURIComponent(tipo))
        .then(r => r.json())
        .then(dados => {
          if (!dados || dados.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.textContent = 'Nenhum item encontrado para esta categoria.';
            tr.appendChild(td);
            tabela.appendChild(tr);
            return;
          }
          dados.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.nome}</td><td>${item.quantidade}</td>`;
            tabela.appendChild(tr);
          });
        })
        .catch(() => {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 2;
          td.textContent = 'Erro ao carregar a tabela.';
          tr.appendChild(td);
          tabela.appendChild(tr);
        });
    }

    // Exporta√ß√µes
    function exportarCategoriaExcel(tipo) {
      // usa PHP para gerar CSV (compat√≠vel com Excel)
      window.location.href = 'exportar_categoria_excel.php?tipo=' + encodeURIComponent(tipo);
    }

    function exportarCategoriaPDF(titulo) {
      const tabela = document.getElementById('tabelaCategoria');
      if (!tabela) return;
      const html = `
        <html>
        <head>
          <meta charset="utf-8">
          <title>${titulo}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h2 { margin: 0 0 12px 0; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #999; padding: 8px; text-align: center; }
            th { background: #eee; }
          </style>
        </head>
        <body>
          <h2>${titulo}</h2>
          ${tabela.outerHTML}
        </body>
        </html>
      `;
      const win = window.open('', '_blank');
      win.document.open();
      win.document.write(html);
      win.document.close();
      win.focus();
      win.print();
      // win.close();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const tipo = getTipoFromURL();
      const titulo = document.getElementById('tituloCategoria');
      titulo.textContent = tipo ? `Categoria: ${tipo}` : 'Categoria';

      carregarTabelaCategoria(tipo);

      document.getElementById('btnExcel').addEventListener('click', () => exportarCategoriaExcel(tipo));
      document.getElementById('btnPDF').addEventListener('click', () => exportarCategoriaPDF(`Relat√≥rio de Estoque - ${tipo}`));
    });
  </script>
</body>
</html>
